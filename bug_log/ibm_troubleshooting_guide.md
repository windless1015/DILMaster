# IBM 模拟常见问题与排查指南

本文档记录了在 `ibm_capsule3d_st_translate` 模拟调试过程中遇到的关键问题及其解决方案。

---

## 问题 1：尾迹出现在物体运动的前方

### 现象
速度场变化区域（尾迹）出现在物体运动的**前方**，而非物理上正确的**后方**。

### 根本原因
**β 参数符号错误**。在 MDF 算法中：
- `β > 0` → 力方向反转 → 尾迹在前方 ❌
- `β < 0` → 力方向正确 → 尾迹在后方 ✅

### 解决方案
```cpp
float beta = -0.5f;  // 必须为负数
```

### 诊断方法
在模拟初期（前 100 步），检查阻力符号：
- 物体向 +X 运动时，阻力应为**正**（阻碍运动）
- 如果阻力为负，说明力方向反转

---

## 问题 2：流场完全没有速度变化

### 现象
即使 β 符号正确，流场仍然没有任何速度响应。

### 根本原因
**耦合强度不足**。组合因素导致：

| 参数 | 问题值 | 推荐值 | 影响 |
|------|-------|-------|------|
| `|β|` | 0.05 | 0.5 | 力太弱 |
| `tau` | 1.1 | 0.8 | 粘性太高，消耗力的效果 |
| `mdf_iter` | 2 | 5 | 迭代不足，耦合松散 |

### 解决方案
参数必须作为整体配置：
```cpp
float tau = 0.8f;
float beta = -0.5f;
int mdf_iter = 5;
```

---

## 问题 3：周期性边界导致尾迹穿透

### 现象
尾迹从一侧边界"穿出"后从另一侧"穿入"，形成对称的伪影。

### 根本原因
X 方向使用了 `BC_PERIODIC`（周期性边界）。

### 解决方案
```cpp
lbm_cfg.bcXMin = lbm::BC_BOUNCE_BACK;  // 壁面
lbm_cfg.bcXMax = lbm::BC_BOUNCE_BACK;
```

---

## 问题 4：模拟数值爆炸 (rho=NaN)

### 现象
密度变为 NaN，速度场全红，模拟发散。

### 根本原因
IBM 力反馈过于激进，LBM 求解器无法承受。

### 解决方案
1. 降低 `|β|` 值
2. 增加 `tau`（增加粘性阻尼）
3. 降低 `U0`（减小速度差）
4. 增加预松弛步数

---

## 参数推荐值速查表

| 参数 | 推荐范围 | 当前值 | 说明 |
|------|---------|--------|------|
| `ds/dx` | 0.5 - 1.0 | 1.0 ✅ | 标记间距 / 网格间距 |
| `β` | -1.0 ~ -0.1 | -0.5 ✅ | **必须为负** |
| `mdf_iter` | 3 - 10 | 5 ✅ | 更多 = 更紧耦合 |
| `tau` | 0.6 - 1.0 | 0.8 ✅ | 太高→粘性大；太低→不稳定 |
| `U0` | < 0.1 | 0.05 ✅ | LBM 低马赫数要求 |

---

## 自动化验证检查清单

代码中应实现以下自动检查：

1. **β 符号检查**：`β > 0` 时发出警告
2. **力方向一致性**：阻力符号应与速度符号相反
3. **ds/dx 范围检查**：超出 0.5-1.0 时发出警告
4. **数值稳定性**：IBM 力超过阈值时抛出异常

---

*文档创建时间：2026-02-05*
